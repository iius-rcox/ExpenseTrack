name: CI Nightly (Chaos & Resilience)

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2:00 AM UTC
  workflow_dispatch:
    inputs:
      chaos_rate:
        description: 'Chaos injection rate (0.0 - 1.0)'
        required: false
        default: '0.25'
      skip_load_tests:
        description: 'Skip load tests'
        required: false
        type: boolean
        default: false

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  chaos-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: expenseflow_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      wiremock:
        image: wiremock/wiremock:3.3.1
        ports:
          - 8080:8080

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore & Build
        run: |
          dotnet restore backend/ExpenseFlow.sln
          dotnet build backend/ExpenseFlow.sln -c Release --no-restore

      - name: Load WireMock Stubs
        run: |
          # Wait for WireMock to be ready
          until curl -s http://localhost:8080/__admin/mappings > /dev/null; do
            echo "Waiting for WireMock..."
            sleep 2
          done
          # Load stubs if they exist
          if [ -f "backend/tests/ExpenseFlow.Scenarios.Tests/Mocks/azure-ai-stubs.json" ]; then
            curl -X POST http://localhost:8080/__admin/mappings \
              -H "Content-Type: application/json" \
              -d @backend/tests/ExpenseFlow.Scenarios.Tests/Mocks/azure-ai-stubs.json
          fi

      - name: Run Chaos Tests
        env:
          CHAOS_ENABLED: "true"
          CHAOS_INJECTION_RATE: ${{ github.event.inputs.chaos_rate || '0.25' }}
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=expenseflow_test;Username=test;Password=test"
          Services__DocumentIntelligence__Endpoint: "http://localhost:8080"
          Services__OpenAI__Endpoint: "http://localhost:8080"
        run: |
          dotnet test backend/tests/ExpenseFlow.Scenarios.Tests \
            --no-build -c Release \
            --filter "Category=Chaos" \
            --logger "trx;LogFileName=chaos-results.trx" \
            --results-directory ./test-results

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-test-results
          path: ./test-results/
          retention-days: 7

  resilience-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: expenseflow_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore & Build
        run: |
          dotnet restore backend/ExpenseFlow.sln
          dotnet build backend/ExpenseFlow.sln -c Release --no-restore

      - name: Run Resilience Tests
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=expenseflow_test;Username=test;Password=test"
        run: |
          dotnet test backend/tests/ExpenseFlow.Scenarios.Tests \
            --no-build -c Release \
            --filter "Category=Resilience" \
            --logger "trx;LogFileName=resilience-results.trx" \
            --results-directory ./test-results

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: resilience-test-results
          path: ./test-results/
          retention-days: 7

  property-exhaustive:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore & Build
        run: |
          dotnet restore backend/ExpenseFlow.sln
          dotnet build backend/ExpenseFlow.sln -c Release --no-restore

      - name: Run Exhaustive Property Tests
        env:
          FSCHECK_MAX_TEST: "10000"
          FSCHECK_END_SIZE: "500"
        run: |
          dotnet test backend/tests/ExpenseFlow.PropertyTests \
            --no-build -c Release \
            --logger "trx;LogFileName=property-results.trx" \
            --results-directory ./test-results

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: property-test-results
          path: ./test-results/
          retention-days: 7

  load-tests:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_load_tests != 'true' }}
    timeout-minutes: 25

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: expenseflow_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore & Build
        run: |
          dotnet restore backend/ExpenseFlow.sln
          dotnet build backend/ExpenseFlow.sln -c Release --no-restore

      - name: Start API Server
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=expenseflow_test;Username=test;Password=test"
          ASPNETCORE_ENVIRONMENT: "Development"
        run: |
          dotnet run --project backend/src/ExpenseFlow.Api -c Release --no-build &
          echo "Waiting for API to start..."
          sleep 15
          curl -f http://localhost:5000/health || exit 1

      - name: Run Load Tests
        env:
          API_BASE_URL: http://localhost:5000
        run: |
          dotnet test backend/tests/ExpenseFlow.LoadTests \
            --no-build -c Release \
            --logger "trx;LogFileName=load-results.trx" \
            --results-directory ./test-results

      - name: Upload NBomber Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-reports
          path: |
            ./test-results/
            ./nbomber-reports/
          retention-days: 7

  report:
    runs-on: ubuntu-latest
    needs: [chaos-tests, resilience-tests, property-exhaustive, load-tests]
    if: always()

    steps:
      - name: Generate Summary
        env:
          CHAOS_RESULT: ${{ needs.chaos-tests.result }}
          RESILIENCE_RESULT: ${{ needs.resilience-tests.result }}
          PROPERTY_RESULT: ${{ needs.property-exhaustive.result }}
          LOAD_RESULT: ${{ needs.load-tests.result }}
        run: |
          echo "# ðŸŒ™ Nightly Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "$CHAOS_RESULT" == "success" ]]; then
            echo "| Chaos Tests | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Chaos Tests | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$RESILIENCE_RESULT" == "success" ]]; then
            echo "| Resilience Tests | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Resilience Tests | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$PROPERTY_RESULT" == "success" ]]; then
            echo "| Property Tests | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Property Tests | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$LOAD_RESULT" == "success" ]]; then
            echo "| Load Tests | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$LOAD_RESULT" == "skipped" ]]; then
            echo "| Load Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Load Tests | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for Failures
        env:
          CHAOS_RESULT: ${{ needs.chaos-tests.result }}
          RESILIENCE_RESULT: ${{ needs.resilience-tests.result }}
          PROPERTY_RESULT: ${{ needs.property-exhaustive.result }}
          LOAD_RESULT: ${{ needs.load-tests.result }}
        if: contains(needs.*.result, 'failure')
        run: |
          echo "::error::One or more nightly test suites failed. Check the workflow run for details."
          echo "Chaos: $CHAOS_RESULT"
          echo "Resilience: $RESILIENCE_RESULT"
          echo "Property: $PROPERTY_RESULT"
          echo "Load: $LOAD_RESULT"
