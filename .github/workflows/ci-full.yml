name: CI Full (PR)

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

concurrency:
  group: ci-full-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: expenseflow_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore
        run: dotnet restore backend/ExpenseFlow.sln

      - name: Build
        run: dotnet build backend/ExpenseFlow.sln --no-restore -c Release

      - name: Run All Backend Tests
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=expenseflow_test;Username=test;Password=test"
        run: |
          # Run tests excluding Scenarios.Tests (which only has Chaos/Resilience tests)
          # and excluding quarantined/load/chaos/resilience categories
          dotnet test backend/tests/ExpenseFlow.Core.Tests \
            --no-build -c Release \
            --filter "Category!=Quarantined" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            --logger "trx;LogFileName=core-results.trx"

          dotnet test backend/tests/ExpenseFlow.Infrastructure.Tests \
            --no-build -c Release \
            --filter "Category!=Quarantined&Category!=Load&Category!=Chaos&Category!=Resilience" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            --logger "trx;LogFileName=infrastructure-results.trx"

          dotnet test backend/tests/ExpenseFlow.Api.Tests \
            --no-build -c Release \
            --filter "Category!=Quarantined" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            --logger "trx;LogFileName=api-results.trx"

          dotnet test backend/tests/ExpenseFlow.Contracts.Tests \
            --no-build -c Release \
            --filter "Category!=Quarantined" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            --logger "trx;LogFileName=contracts-results.trx"

          # Note: Scenarios.Tests excluded - all tests are Chaos/Resilience (run in nightly)

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/**/coverage.cobertura.xml
          flags: backend
          fail_ci_if_error: false

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Backend Tests
          path: ./coverage/*.trx
          reporter: dotnet-trx

  frontend-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npm run type-check

      - name: Unit Tests
        run: npm run test:unit

      - name: Integration Tests
        run: npm run test:integration

      - name: Contract Tests
        run: npm run test:contracts

      - name: Coverage Report
        run: npm run test:coverage

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: frontend/coverage/coverage-final.json
          flags: frontend
          fail_ci_if_error: false

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    timeout-minutes: 15
    # TODO: E2E tests need proper infrastructure setup (DB service, backend startup)
    # Currently disabled - uncomment 'continue-on-error: false' when fixed
    continue-on-error: true

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: expenseflow_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Playwright
        run: npx playwright install --with-deps chromium
        working-directory: frontend

      - name: Build Backend
        run: dotnet build backend/src/ExpenseFlow.Api -c Release

      - name: Start Backend API
        run: |
          dotnet run --project backend/src/ExpenseFlow.Api -c Release &
          # Wait for backend to be ready (max 60 seconds)
          for i in {1..60}; do
            if curl -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/60)"
            sleep 1
          done
        env:
          # Use PostgreSQL key (matches appsettings.json)
          ConnectionStrings__PostgreSQL: "Host=localhost;Database=expenseflow_test;Username=test;Password=test"
          ASPNETCORE_ENVIRONMENT: Development
          ASPNETCORE_URLS: http://localhost:5000

      - name: Run E2E Tests
        run: npm run test:e2e
        working-directory: frontend
        env:
          # Proxy /api to local backend
          VITE_API_PROXY_TARGET: http://localhost:5000

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-results
          path: frontend/test-results/
          retention-days: 7

  coverage-gate:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    timeout-minutes: 2

    steps:
      - name: Check Coverage Threshold
        uses: codecov/codecov-action@v4
        with:
          # Note: Set fail_ci_if_error to false until CODECOV_TOKEN is configured
          # Coverage is still uploaded by test jobs; this just won't block PRs
          fail_ci_if_error: false
          verbose: true

  merge-gate:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, coverage-gate]
    if: always()

    steps:
      - name: Check All Jobs
        env:
          BACKEND_RESULT: ${{ needs.backend-tests.result }}
          FRONTEND_RESULT: ${{ needs.frontend-tests.result }}
          E2E_RESULT: ${{ needs.e2e-tests.result }}
          COVERAGE_RESULT: ${{ needs.coverage-gate.result }}
        run: |
          if [[ "$BACKEND_RESULT" != "success" ]] ||
             [[ "$FRONTEND_RESULT" != "success" ]] ||
             [[ "$E2E_RESULT" != "success" ]] ||
             [[ "$COVERAGE_RESULT" != "success" ]]; then
            echo "One or more required jobs failed"
            echo "Backend: $BACKEND_RESULT"
            echo "Frontend: $FRONTEND_RESULT"
            echo "E2E: $E2E_RESULT"
            echo "Coverage: $COVERAGE_RESULT"
            exit 1
          fi
          echo "All jobs passed!"

      - name: Generate Summary
        run: |
          echo "## PR Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Gate | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
